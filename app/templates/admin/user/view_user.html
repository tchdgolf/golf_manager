{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %} {# 비밀번호 초기화 폼 사용 시 필요 #}

{% block title %}{{ title }} - 관리자{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ title }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" class="btn btn-sm btn-outline-primary me-2">
            <i class="bi bi-pencil-square"></i> 정보 수정
        </a>
        <a href="{{ url_for('admin.list_users') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-list-ul"></i> 회원 목록
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <h4>기본 정보</h4>
        <table class="table table-bordered">
            <tbody>
                <tr>
                    <th scope="row" style="width: 30%;">회원 ID</th>
                    <td>{{ user.id }}</td>
                </tr>
                <tr>
                    <th scope="row">이름</th>
                    <td>{{ user.name }}</td>
                </tr>
                <tr>
                    <th scope="row">연락처</th>
                    <td>{{ user.phone }} ({{ user.phone_last4 }})</td>
                </tr>
                <tr>
                    <th scope="row">관리자 여부</th>
                    <td>
                        {% if user.is_admin %}
                            <span class="badge bg-info">관리자</span>
                        {% else %}
                            <span class="badge bg-light text-dark">일반 회원</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th scope="row">가입일</th>
                    <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M:%S') if user.created_at else '-' }}</td>
                </tr>
                <tr>
                    <th scope="row">마지막 로그인</th>
                    <td>{{ user.last_login_at.strftime('%Y-%m-%d %H:%M:%S') if user.last_login_at else '기록 없음' }}</td>
                </tr>
                <tr>
                    <th scope="row">메모</th>
                    <td>{{ user.memo | nl2br if user.memo else '-' }}</td> {# nl2br: 줄바꿈 표시 #}
                </tr>
            </tbody>
        </table>

        <h4 class="mt-4">비밀번호 관리</h4>
        <p>회원의 비밀번호를 '0000'으로 초기화할 수 있습니다.</p>
        <form action="{{ url_for('admin.reset_user_password', user_id=user.id) }}" method="POST" onsubmit="return confirm('정말로 \'{{ user.name }}\' 회원의 비밀번호를 \'0000\'으로 초기화하시겠습니까?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {{ wtf.form_field(password_reset_form.submit, class="btn btn-warning") }}
        </form>

    </div>

    <div class="row mt-4"> {# 이용권, 예약 등 추가 정보 섹션 #}
        <div class="col-md-12">
            <h4><i class="bi bi-ticket-detailed"></i> 보유 이용권 정보</h4>
            {% if user_tickets %} 
                <div class="list-group">
                    {% for ticket in user_tickets %} 
                    <div class="list-group-item list-group-item-action flex-column align-items-start {{ 'list-group-item-light text-muted' if not ticket.is_active }}">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">
                                {{ ticket.name }}
                                {% if ticket.is_active %}
                                    <span class="badge bg-success ms-1">활성</span>
                                {% elif ticket.is_expired %}
                                    <span class="badge bg-danger ms-1">만료</span>
                                {% elif ticket.is_used_up %}
                                    <span class="badge bg-warning text-dark ms-1">소진</span>
                                {% else %}
                                     <span class="badge bg-secondary ms-1">비활성</span>
                                {% endif %}
                            </h5>
                            <small>ID: {{ ticket.id }}</small>
                        </div>
                        <p class="mb-1">
                            <span class="me-3"><strong>기간:</strong> {{ ticket.start_date.strftime('%y-%m-%d') }} ~ {{ ticket.expiry_date.strftime('%y-%m-%d') if ticket.expiry_date else '없음' }}</span>
                            <span class="me-3"><strong>타석 횟수:</strong> {{ ticket.remaining_taseok_count if ticket.remaining_taseok_count is not none else '-' }}/{{ ticket.total_taseok_count if ticket.total_taseok_count is not none else '-' }}</span>
                            <span><strong>레슨 횟수:</strong> {{ ticket.remaining_lesson_count if ticket.remaining_lesson_count is not none else '-' }}/{{ ticket.total_lesson_count if ticket.total_lesson_count is not none else '-' }}</span>
                        </p>
                        <p class="mb-1">
                            <span class="me-3"><strong>담당 프로:</strong> {{ ticket.pro.name if ticket.pro else '미지정' }}</span>
                            <span><strong>가격:</strong> {{ "{:,}".format(ticket.price) if ticket.price is not none else '-' }} 원</span>
                        </p>
                        {% if ticket.memo %}
                        <p class="mb-1"><small><strong>메모:</strong> {{ ticket.memo | nl2br }}</small></p>
                        {% endif %}
    
                        {# 홀딩 정보 표시 (향후 구현) #}
                        {% if ticket.holdings and ticket.holdings.count() > 0 %}
                        <div class="mt-2 mb-1 alert alert-info py-1 px-2" style="font-size: 0.85rem;">
                            <small><strong><i class="bi bi-pause-circle"></i> 홀딩 내역:</strong>
                            {% for holding in ticket.holdings %}
                                {{ holding.start_date.strftime('%y/%m/%d') }} ~ {{ holding.end_date.strftime('%y/%m/%d') }} ({{ holding.duration_days }}일){% if not loop.last %}, {% endif %}
                            {% endfor %}
                            </small>
                        </div>
                        {% endif %}
    
                        {# 관리 버튼 영역 #}
                        <div class="mt-2 text-end">
                             {# 홀딩 추가/관리 버튼 (향후 활성화) #}
                             <button type="button" class="btn btn-sm btn-outline-secondary me-1" data-bs-toggle="modal" data-bs-target="#holdingModal" data-ticket-id="{{ ticket.id }}" data-ticket-name="{{ ticket.name }}">
                                <i class="bi bi-pause-btn"></i> 홀딩 관리
                             </button>
                             <a href="{{ url_for('admin.edit_ticket', ticket_id=ticket.id) }}" class="btn btn-sm btn-outline-primary me-1">
                                <i class="bi bi-pencil-square"></i> 수정
                             </a>
                             {# 삭제 버튼 (향후 활성화, 조건부 표시) #}
                             <form action="#" method="POST" class="d-inline"> {# action="#" 또는 비워둠 #}
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger" disabled title="삭제 (준비중)">
                                    <i class="bi bi-trash"></i> 삭제
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">보유한 이용권이 없습니다.</p>
            {% endif %}
            <div class="mt-3">
                 <a href="{{ url_for('admin.issue_ticket', user_id_from_url=user.id) }}" class="btn btn-info">
                     <i class="bi bi-plus-circle"></i> 이 회원에게 이용권 추가 발급
                 </a>
            </div>
        </div>
    
        {# 예약 내역, 총 잔여 레슨 등 나머지 정보 (이전 코드와 유사하게 배치) #}
        {# ... #}
    
    </div>
    
</div>

{# 홀딩 관리 모달 (향후 구현) - 페이지 하단에 추가 #}
<div class="modal fade" id="holdingModal" tabindex="-1" aria-labelledby="holdingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="holdingModalLabel">홀딩 관리: <span id="holdingTicketName"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>이곳에 해당 이용권(<span id="holdingTicketId"></span>)의 홀딩 추가 폼 및 기존 홀딩 목록이 표시됩니다.</p>
        {# 홀딩 폼 및 목록 내용 (향후 구현) #}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        <button type="button" class="btn btn-primary">홀딩 저장 (구현 필요)</button>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block scripts %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{# 홀딩 모달 관련 JavaScript (향후 구현) #}
<script>
    const holdingModal = document.getElementById('holdingModal');
    if (holdingModal) {
        holdingModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget; // 모달을 트리거한 버튼
            const ticketId = button.getAttribute('data-ticket-id');
            const ticketName = button.getAttribute('data-ticket-name');

            const modalTitle = holdingModal.querySelector('.modal-title #holdingTicketName');
            const modalBodyTicketId = holdingModal.querySelector('.modal-body #holdingTicketId');

            if (modalTitle) modalTitle.textContent = ticketName;
            if (modalBodyTicketId) modalBodyTicketId.textContent = ticketId;

            // TODO: 여기에 Ajax로 해당 ticketId의 홀딩 정보 로드 및 폼 생성 로직 추가
            console.log(`Loading holding info for ticket ID: ${ticketId}`);
        });
    }
</script>
{% endblock %}